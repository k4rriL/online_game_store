{% load staticfiles %}
<div id="gamesDiv"></div>
<script>
var articleOffset = 0;
var timeout = null;

var timeout2 = null;

var articleLoader = function(url) {
    $.ajax({
        url: url,
        success: function(data) {
            if (data.length > 0) {
                for (var i = 0, total = data.length; i < total; i++) {
                  var description = data[i].description
                  var name = data[i].name
                  if (typeof description !== 'undefined' && description.length > 65){
                    description = description.substr(0, 63)+'..';
                  }
                  if (typeof name !== 'undefined' && name.length > 14){
                    name = name.substr(0, 13)+'..';
                  }
                  {% static "" as baseUrl%}
                    var compile_data;
                    compile_data ='<div class="col-md-3 col-sm-4 col-xs-6 card-container"> <div class="card"> ' +
                    '<a href="/game/' + data[i].id + '"><span class=card-link></span></a>' +
                    '<div class="card-image"> <img class="img-responsive" src="{{baseUrl}}'+ data[i].category + '.jpg">' +
                                '<span class="game-title">' + name + '</span></div>' +
                                  '<div class="game-description"><p>'+  description + '</p>' +
                            '</div><div class="game-category">'+data[i].category + '</div><div class="game-price">'+ data[i].price +'â‚¬</div></div></div></div>';
                    $('#gamesDiv').append(compile_data);
                }

                /* update the offset */
                articleOffset += data.length
            } else {
							  if (articleOffset === 0){
									$('#gamesDiv').append('No games found');
								}
            }
        }
    });
}

var category;

{% if category != None %}
  category = "{{category}}"
{%else %}
  category = ""
{% endif %}

/* Infinite scrolling for fetching articles */
var $window = $(window);
function prodScrollPosition() {
  if (timeout2) {
    clearTimeout(timeout2);
  }
  timeout2 = setTimeout(function() {
    var distance = $window.scrollTop() + $window.height();
    if ($('body').height() <= distance && $('#gamesDiv')) {
      if (category !== ""){
        articleLoader('/api/games/?offset=' + articleOffset + '&category=' + category);
      }else{
        articleLoader('/api/games/?offset=' + articleOffset);
      }

    }
  }, 50)
}

$window.scroll(prodScrollPosition).scroll();

$(function() {
    "use strict";

		$("#search").submit(function(event) {
			event.preventDefault();
			articleOffset = 0;
			$('#gamesDiv').html("");
      var values = {};
			$.each($('#search').serializeArray(), function(i, field) {
			    values[field.name] = field.value;
			});
			console.log(values["query"]);
      if (category !== ""){
        articleLoader('/api/games/?offset=' + articleOffset + '&category=' + category  + '&q=' + values["query"]);
      }else{
        articleLoader('/api/games/?offset=' + articleOffset  + '&q=' + values["query"]);
      }
		});

    $('#search').keyup(function(e){
      if (timeout) {
        clearTimeout(timeout);
      }
      timeout = setTimeout(function() {
        var q = $('#query').val();
        console.log(q);
        articleOffset = 0;
  			$('#gamesDiv').html("");

        if (category !== ""){
          articleLoader('/api/games/?offset=' + articleOffset + '&category=' + category  + '&q=' + q);
        }else{
          articleLoader('/api/games/?offset=' + articleOffset  + '&q=' + q);
        }
      }, 150);


    });

});

</script>
